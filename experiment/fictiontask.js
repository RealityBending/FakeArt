// Condition assignment ============================================
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1))
        ;[array[i], array[j]] = [array[j], array[i]]
    }
    return array
}

function assignCondition(stimuli_list) {
    let new_stimuli_list = []
    // Loop through unique styles
    for (let style of [...new Set(stimuli_list.map((a) => a.Style))]) {
        // Get all stimuli of this style
        var style_stimuli = stimuli_list.filter((a) => a.Style == style)

        // Shuffle style_stimuli
        style_stimuli = shuffleArray(style_stimuli) // Custom function defined above

        // Assign condition to each image
        let conditions = ["AI", "Human", "Forgery"]
        let third = Math.floor(style_stimuli.length / 3) // Base number of images for each condition
        let remainder = style_stimuli.length % 3 // Extra images

        let index = 0
        for (let i = 0; i < 3; i++)
            for (let j = 0; j < third; j++) {
                style_stimuli[index].Condition = conditions[i]
                index++
            }

        let shuffledConditions = shuffleArray(conditions) // Shuffle conditions to assign extra images to
        for (let i = 0; i < remainder; i++) {
            style_stimuli[index].Condition = shuffledConditions[i]
            index++
        }

        // Add to new_stimuli_list
        new_stimuli_list.push(...style_stimuli)
    }
    return shuffleArray(new_stimuli_list)
}

// Variables ===================================================================
var fiction_trialnumber = 1
var color_cues = shuffleArray(["red", "blue", "green"])

color_cues = {
    AI: color_cues[0],
    Human: color_cues[1],
    Forgery: color_cues[2],
}

var text_cue = {
    AI: "AI-Generated",
    Human: "Human-Original",
    Forgery: "Human-Forgery",
}

stimuli = assignCondition(stimuli_list)

// Screens =====================================================================
const fiction_instructions1 = {
    type: jsPsychSurvey,
    data: { screen: "fiction_instructions1" },
    survey_json: {
        showQuestionNumbers: false,
        completeText: "Let's start",
        pages: [
            {
                elements: [
                    {
                        type: "html",
                        name: "Instructions",
                        html: `
  <h3>Part 2/4</h3>
  <h1>Instructions</h1>
  <h3>What you will see</h3>
  <div style="text-align: left;">
    <p>This study stems from a multi-disciplinary collaboration involving neuroscientists, artists, and computer scientists from the University of Sussex. 
    Our aim is to understand whether computer-generated works of art evoke similar responses to works created by human artists.</p>

    <p>In the next part, you will be presented with <u>3 types of images</u>:</p>

    <div style="display: flex; align-items: center; margin-bottom: 20px;">
      <div style="flex: 1;">
        <p><b><li>Original paintings</b> (preceded by the word 
          <b style="color: ${color_cues["Human"]}">Original</b>):<br>
          Images of original paintings taken from public artwork databases.</p>
      </div>
      <div style="flex: 1; text-align: center;">
        <img src="media/example_original.png" alt="Original painting" style="width:100%; max-width: 200px;">
        <p style ='font-size: 80%; color: gray'>Starry Night by Vincent van Gogh (1889)</p>
      </div>
    </div>

    <div style="display: flex; align-items: center; margin-bottom: 20px;">
      <div style="flex: 1;">
        <p><b><li>AI-Generated</b> (preceded by the word 
          <b style="color: ${color_cues["AI"]}">AI-Generated</b>):<br>
          Images generated using platforms like <i>Midjourney</i> and <i>Stable Diffusion</i>, either in a new style or inspired by existing artists or artworks.</p>
      </div>
      <div style="flex: 1; text-align: center;">
        <img src="media/example_AI.jpg" alt="AI-Generated painting" style="width:100%; max-width: 240px;">
        <p style ='font-size: 80%; color: gray'>Paris in the style of Van Gogh, generated by Midjourney</p>
      </div>
    </div>

    <div style="display: flex; align-items: center;">
      <div style="flex: 1;">
        <p><b><li>Forgeries</b> (preceded by the word 
          <b style="color: ${color_cues["Forgery"]}">Human Copy</b>):<br>
          Copies of famous paintings or works mimicking a style, often by anonymous forgers, intended to be sold as originals.</p>
      </div>
      <div style="flex: 1; text-align: center;">
        <img src="media/example_forgery.jpg" alt="Forgery painting" style="width:100%; max-width: 240px;">
        <p style ='font-size: 80%; color: gray'>Portrait of a forger: John Myatt has been described as committing the biggest art fraud of the 20th century by faking over 200 different artists.</p>
      </div>
    </div>
  </div>

  <h3>What you need to do</h3>
  <p>Each image will be briefly presented on the screen. After each image, you will be asked to <b>rate your aesthetic experience</b> on the following dimensions:</p>
  <ul>
    <li><b style="color: #880E4F">Beauty</b>: How beautiful do you find this image? This question is about the aesthetic quality of the artwork.</li>
    <li><b style="color: #880E4F">Meaning</b>: Does this artwork seem to express something meaningful, symbolic, or thought-provoking to you? Do you feel like it conveys a deeper message?</li>
    <li><b style="color: #880E4F">Value</b>: How much would you be willing to pay to own this artwork and display it in your home?</li>
    <li><b style="color: #880E4F">Familiarity</b>: Does this image remind you of something you've seen before? Refers to how much the image feels like something you have already seen before - whether it's the artwork, its style or subject.</ul>
  Potential?
  <ul>
    <li><b style="color: #880E4F">Liking</b>: To what extent do you like or dislike the image based on personal preference.</li>
    <li><b style="color: #880E4F">Emotions</b>: How positive or negative the emotions are that you feel when looking at the image.</li>
    
  </ul>
`,
                    },
                ],
            },
        ],
    },
}

// var fiction_instructions1 = {
//     type: jsPsychHtmlButtonResponse,
//     css_classes: ["narrow-text"],
//     stimulus: `
//   <h1>Part 2/4</h1>
//   <div style="text-align: left;">
//     <p>This study stems from a multi-disciplinary collaboration involving neuroscientists, artists, and computer scientists from the University of Sussex.
//     Our aim is to understand whether computer-generated works of art evoke similar responses to works created by human artists.</p>

//     <p>In the next part, you will be presented with 3 types of images:</p>

//     <div style="display: flex; align-items: center; margin-bottom: 20px;">
//       <div style="flex: 1;">
//         <p><b><li>Original paintings</b> (preceded by the word
//           <b style="color: ${color_cues["Human"]}">Original</b>):<br>
//           Images of original paintings taken from public artwork databases.</p>
//       </div>
//       <div style="flex: 1; text-align: center;">
//         <img src="media/example_original.png" alt="Original painting" style="width:100%; max-width: 200px;">
//         <p style ='font-size: 80%; color: gray'>Starry Night by Vincent van Gogh (1889)</p>
//       </div>
//     </div>

//     <div style="display: flex; align-items: center; margin-bottom: 20px;">
//       <div style="flex: 1;">
//         <p><b>AI-Generated</b> (preceded by the word
//           <b style="color: ${color_cues["AI"]}">AI-Generated</b>):<br>
//           Images generated using platforms like <i>Midjourney</i> and <i>Stable Diffusion</i>, either in a new style or inspired by existing ones.</p>
//       </div>
//       <div style="flex: 1; text-align: center;">
//         <img src="media/example_AI.jpg" alt="AI-Generated painting" style="width:100%; max-width: 240px;">
//         <p style ='font-size: 80%; color: gray'>Paris in the style of Van Gogh, generated by Midjourney</p>
//       </div>
//     </div>

//     <div style="display: flex; align-items: center;">
//       <div style="flex: 1;">
//         <p><b>Forgeries</b> (preceded by the word
//           <b style="color: ${color_cues["Forgery"]}">Human Copy</b>):<br>
//           Copies of famous paintings or works mimicking a style, often by anonymous forgers, intended to be sold as originals.</p>
//       </div>
//       <div style="flex: 1; text-align: center;">
//         <img src="media/example_forgery.jpg" alt="Forgery painting" style="width:100%; max-width: 240px;">
//         <p style ='font-size: 80%; color: gray'>Portrait of a forger: John Myatt has been described as committing the biggest art fraud of the 20th century by faking over 200 different artists.</p>
//       </div>
//     </div>
//   </div>
// `,
// "<h1>Part 2/4</h1>" +
// "<div style='text-align: left'>" +
// "<p>This study stems out of a multi-disciplinary collaboration involving neuroscientists, artists and computer scientists from the University of Sussex.</p>" +
// "<p>Our aim is to understand whether computer generated works of art evokes similar responses to works created by human artists.</p>" +
// "<p>In the next part, you will be presented with 3 types of images:</p>" +
// "<ul>" +
// "<li><b>Original paintings</b> (preceded by the word '<b style='color:" +
// color_cues["Human"] +
// "'>Original</b>'): Images of original paintings taken from public artwork databases</li>" +
// "<li><b>AI-Generated</b> (preceded by the word '<b style='color:" +
// color_cues["AI"] +
// "'>AI-Generated</b>'): Images generated using various platforms (primarily Midjourney© and Stable Diffusion©), prompted to painting either in a new and original style or inspired by a particular artist or style.</li>" +
// "<li><b>Forgeries</b> (preceded by the word '<b style='color:" +
// color_cues["Forgery"] +
// "'>Human Copy</b>'): Copies of famous paintings (or mimicking the style of a particular painter) made by (often anonymous) forgers in order to be sold as originals.</li>" +
// "</ul>" +
// // Add 2 images side by side
// "<div class='row' style='display: flex; justify-content: center;'>" +
// "<div class='column' style='text-align: center;'>" +
// "<img src='media/example_original.png' alt='Example of Original' style='width:100%; max-width: 200px;'></div>" +
// "<p>Original Image</p>" +
// "<div class='column' style='text-align: center;'>" +
// "<img src='media/example_AI.jpg' alt='Example of AI-Generated' style='width:100%; max-width: 240px;'></div>" +
// "<p>AI-Generated Image</p>" +
// "<div class='column' style='text-align: center;'>" +
// "<img src='media/example_forgery.jpg' alt='Example of forgery' style='width:100%; max-width: 240px;'></div>" +
// "<p>Portrait of a forger: John Myatt has been described as committing the biggest art fraud of the 20th century by faking over 200 different artists.</p>" +
// "</div></div>" +
// // "<p>The algorithm produces a variety of paintings, some entirely original and others that are strongly inspired by specific works of art and thus may resemble pieces you've seen before.</p>" +
// "mages of paintings generated by our algorithm (preceded by the word '<b style='color:" +
// color_cues["AI"] +
// "'>AI-Generated</b>'), intermixed with paintings by human artists that are either original pieces (preceded by the word '<b style='color:" +
// color_cues["Human"] +
// "'>Original</b>') or forgeries (preceded by the word '<b style='color:" +
// color_cues["Forgery"] +
// "'>Human-Forgery</b>') taken from public artwork databases, adjusted to be of similar dimension and aspect as the artificially-generated images.</p > " +
// "<ul style='list-style-type: \"- \";'>" +
// "<li>item</li>" +
// "</ul>" +
// "<p>The artworks will be <b>briefly presented on the screen</b>. After each image, you will be asked to rate it along several dimensions:</p>" +
// '<li><b style="color: purple">Emotional Valence</b>: Refers to how positive or negative the emotions are that you feel when looking at the image.</li>' +
// '<li><b style="color: purple">Emotional Arousal</b>: Refers to the level of emotional intensity you feel, from very calm and soothing to very exciting or stimulating, when looking at the image.</li>' +
// '<li><b style="color: purple">Liking</b>: To what extent do you like or dislike the image based on personal preference.</li>' +
// '<li><b style="color: purple">Beauty</b>: To what extent do you find this image to be objectively beautiful or aesthetically pleasing.</li>' +
// '<li><b style="color: purple">Familiarity</b>: To what extent does the image appear similar to something you have seen before.</li>' +
// "<p>Note that we are interested in your <b>first impression</b>, so please respond according to your gut feelings.</p>" +
// "<p style='text-align: center';>Press start once you are ready.</p>",
//     choices: ["Start"],
//     data: { screen: "fiction_instructions1" },
// }

var fiction_instructions2 = {
    type: jsPsychHtmlButtonResponse,
    css_classes: ["narrow-text"],
    stimulus:
        "<h1>Part 4/4</h1>" +
        "<div style='text-align: left'>" +
        "<p>Thank you! In this final phase, we would like to see if you thought our <b>image generation algorithm</b> was able to produce artworks that were indistinguishable from those created by humans.</p>" +
        "<p>But there is <b>something important</b> we need to tell you... In the previous phase, some images were <b style='color: orange'>intentionally mislabelled</b> (we told you it was AI-generated when it was actually a human creation and we told you it was a forgery when it was an original work of art).</p>" +
        "<p>In this phase, we want you to tell us for each image <b>what you think is the correct description!</b> " +
        "We will briefly present all the images once more, and your task is to tell us if you think the image is AI-generated or a human-creation and whether you think the image is an original or a forgery. Indicate your degree of <b>confidence</b> and certainty by selecting larger numbers.</p>" +
        "<p style='text-align: center';>Press start once you are ready.</p>",
    choices: ["Start"],
    data: { screen: "fiction_instructions2" },
    on_finish: function () {
        fiction_trialnumber = 1 // Reset trial counter
    },
}

var fiction_preloadstims = {
    type: jsPsychPreload,
    images: stimuli_list.map((a) => "stimuli/stimuli/" + a.Item),
    message: "Please wait while the experiment is being loaded (it can take a few seconds)",
}

var fiction_fixation1a = {
    type: jsPsychHtmlKeyboardResponse,
    // on_start: function () {
    //     document.body.style.cursor = "none"
    // },
    stimulus: "<div style='font-size:500%; position:fixed; text-align: center; top:50%; bottom:50%; right:20%; left:20%'>+</div>",
    choices: ["s"],
    trial_duration: 500,
    save_trial_parameters: { trial_duration: true },
    data: function () {
        return {
            screen: "fiction_fixation1a",
            item: jsPsych.timelineVariable("stimulus"),
        }
    },
}

var fiction_cue = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function () {
        var cond = jsPsych.timelineVariable("Condition")
        return (
            "<div style='font-size:450%; position:fixed; text-align: center; top:50%; bottom:50%; right:20%; left:20%; color: " +
            color_cues[cond] +
            "'><b>" +
            text_cue[cond] +
            "</b></div>"
        )
    },
    data: function () {
        var cond = jsPsych.timelineVariable("Condition")
        return {
            screen: "fiction_cue",
            color: color_cues[cond],
            condition: cond,
            item: jsPsych.timelineVariable("stimulus"),
        }
    },
    choices: ["s"],
    trial_duration: 1000,
    save_trial_parameters: { trial_duration: true },
}

var fiction_fixation1b = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<div style='font-size:500%; position:fixed; text-align: center; top:50%; bottom:50%; right:20%; left:20%'>+</div>",
    choices: ["s"],
    trial_duration: 500,
    save_trial_parameters: { trial_duration: true },
    data: function () {
        return {
            screen: "fiction_fixation1b",
            item: jsPsych.timelineVariable("stimulus"),
        }
    },
    extensions: [
        {
            type: jsPsychExtensionWebgazer,
            params: { targets: ["#jspsych-html-keyboard-response-stimulus"] },
        },
    ],
}

var fiction_showimage1 = {
    type: jsPsychImageKeyboardResponse,
    stimulus: function () {
        return "stimuli/stimuli/" + jsPsych.timelineVariable("Item")
    },
    stimulus_height: function () {
        if (window.innerHeight < window.innerWidth) {
            return Math.round(0.9 * window.innerHeight)
        } else {
            return null
        }
    },
    stimulus_width: function () {
        if (window.innerHeight > window.innerWidth) {
            return Math.round(0.9 * window.innerWidth)
        } else {
            return null
        }
    },
    trial_duration: 10000,
    choices: ["s"],
    save_trial_parameters: { trial_duration: true },
    data: function () {
        return {
            screen: "fiction_image1",
            window_width: window.innerWidth,
            window_height: window.innerHeight,
            trial_number: fiction_trialnumber,
        }
    },
    on_finish: function () {
        fiction_trialnumber += 1
    },
    // Enable webgazer
    extensions: [
        {
            type: jsPsychExtensionWebgazer,
            params: { targets: ["#jspsych-image-keyboard-response-stimulus"] },
        },
    ],
}

var fiction_ratings1 = {
    type: jsPsychSurvey,
    survey_json: {
        goNextPageAutomatic: true,
        showQuestionNumbers: false,
        showNavigationButtons: false,
        title: function () {
            return "Rating - " + Math.round(((fiction_trialnumber - 1) / stimuli.length) * 100) + "%"
        },
        description: "Rate the following on your personal feelings.",
        pages: [
            {
                elements: [
                    {
                        type: "rating",
                        name: "Emotional Valence",
                        title: "Looking at this artwork makes me feel:",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "Very negative",
                        maxRateDescription: "Very positive",
                        displayMode: "buttons",
                    },
                    {
                        type: "rating",
                        name: "Emotional Arousal",
                        title: "Looking at this artwork makes me feel:",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "Very calm",
                        maxRateDescription: "Very excited",
                        displayMode: "buttons",
                    },
                    {
                        type: "rating",
                        name: "Liking",
                        title: "I like this artwork:",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "Not at all",
                        maxRateDescription: "Very much",
                        displayMode: "buttons",
                    },
                    {
                        type: "rating",
                        name: "Beauty",
                        title: "I think this artwork is:",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "Not at all beautiful",
                        maxRateDescription: "Very beautiful",
                        displayMode: "buttons",
                    },
                    {
                        type: "radiogroup",
                        name: "Familiarity",
                        title: "This artwork is:",
                        isRequired: true,
                        choices: ["Unfamiliar", "Familiar with the style", "Familiar with the artist", "I recognize this specific artwork"],
                    },
                ],
            },
        ],
    },
    data: {
        screen: "fiction_ratings1",
    },
}

var fiction_phase1a = {
    timeline_variables: stimuli.slice(0, Math.ceil(stimuli.length / 2)), //.slice(0, 3), // TODO: remove this
    timeline: [fiction_fixation1a, fiction_cue, fiction_fixation1b, fiction_showimage1, fiction_ratings1],
}

var fiction_phase1_break = {
    type: jsPsychHtmlButtonResponse,
    css_classes: ["narrow-text"],
    stimulus:
        "<h1>Break Time</h1>" +
        "<div style='text-align: left'>" +
        "<p>We know these types of experiment can feel a bit repetitive and tedious, " +
        "but it is important for us that you stay focus until the end. Please take this opportunity to <b>take a break and relax your neck and eyes</b>.</p>",
    choices: ["Ready to continue!"],
    data: { screen: "fiction_phase1_break" },
}

var fiction_phase1b = {
    timeline_variables: stimuli.slice(Math.ceil(stimuli.length / 2), stimuli.length), //.slice(0, 3), // TODO: remove this
    timeline: [fiction_fixation1a, fiction_cue, fiction_fixation1b, fiction_showimage1, fiction_ratings1],
}

// Stage 2 loops and variables

var fiction_fixation2 = {
    type: jsPsychHtmlKeyboardResponse,
    // on_start: function () {
    //     document.body.style.cursor = "none"
    // },
    stimulus: "<div  style='font-size:500%; position:fixed; text-align: center; top:50%; bottom:50%; right:20%; left:20%'>+</div>",
    choices: ["s"],
    trial_duration: 500,
    save_trial_parameters: { trial_duration: true },
    data: { screen: "fiction_fixation2" },
}

var fiction_showimage2 = {
    type: jsPsychImageKeyboardResponse,
    stimulus: function () {
        return "stimuli/stimuli/" + jsPsych.timelineVariable("Item")
    },
    stimulus_height: function () {
        if (window.innerHeight < window.innerWidth) {
            return Math.round(0.9 * window.innerHeight)
        } else {
            return null
        }
    },
    stimulus_width: function () {
        if (window.innerHeight > window.innerWidth) {
            return Math.round(0.9 * window.innerWidth)
        } else {
            return null
        }
    },
    trial_duration: 1000,
    choices: ["s"],
    save_trial_parameters: { trial_duration: true },
    data: { screen: "fiction_image2", trial_number: fiction_trialnumber },
    on_finish: function () {
        fiction_trialnumber += 1
    },
}

var fiction_ratings2 = {
    type: jsPsychSurvey,
    css_classes: ["colored-scale"],
    survey_json: {
        goNextPageAutomatic: true,
        showQuestionNumbers: false,
        showNavigationButtons: false,
        title: function () {
            return "Rating - " + Math.round(((fiction_trialnumber - 1) / stimuli.length) * 100) + "%"
        },
        pages: [
            {
                elements: [
                    {
                        type: "rating",
                        name: "Human_vs_AI",
                        title: "I think this image is...",
                        description: "Indicate your confidence that the image is a human or AI creation",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "AI-Generated",
                        maxRateDescription: "Human-Creation",
                        displayMode: "buttons",
                    },
                    {
                        type: "rating",
                        name: "Original_vs_Forgery",
                        title: "I think this image is...",
                        description: "Indicate your confidence that the image is a forgery or an original piece",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "Forgery",
                        maxRateDescription: "Original",
                        displayMode: "buttons",
                    },
                ],
            },
        ],
    },
    data: {
        screen: "fiction_ratings2",
    },
}

var fiction_phase2 = {
    timeline_variables: shuffleArray(stimuli), // .slice(0, 3) TODO: remove this
    timeline: [fiction_fixation2, fiction_showimage2, fiction_ratings2],
}

// Feedback ====================================================================
/*
var fiction_feedback1 = {
    type: jsPsychSurvey,
    survey_json: {
        title: "Thank you!",
        description: "Before we start the second phase, we wanted to know your thoughts.",
        showQuestionNumbers: false,
        elements: [
            {
                type: "checkbox",
                name: "Feedback_2",
                title: "AI-Generation Algorithm",
                description: "Please select all that apply",
                choices: [
                    "The difference between the paintings by humans and the AI-generated paintings was obvious",
                    "The difference between the photos and the AI-generated images was subtle",
                    "I didn't see any difference between photos and AI-generated images",
                    "I felt like the labels ('Photograph' and 'AI-Generated') were not always correct",
                    "I felt like the labels were reversed (e.g., 'Photograph' for AI-generated images and vice versa)",
                    "I feel like all the images were photos",
                    "I feel like all the images were AI-generated",
                ],
                showOtherItem: true,
                showSelectAllItem: false,
                showNoneItem: false,
            },
            {
                visibleIf: "{Feedback_2} anyof ['I feel like all the images were photos']",
                title: "How certain are you that all images were photos?",
                name: "Feedback_2_ConfidenceReal",
                type: "rating",
                rateMin: 0,
                rateMax: 5,
                minRateDescription: "Not at all",
                maxRateDescription: "Completely certain",
            },
            {
                visibleIf: "{Feedback_2} anyof ['I feel like all the images were AI-generated']",
                title: "How certain are you that all images were AI-generated?",
                name: "Feedback_2_ConfidenceFake",
                type: "rating",
                rateMin: 0,
                rateMax: 5,
                minRateDescription: "Not at all",
                maxRateDescription: "Completely certain",
            },
        ],
    },
    data: {
        screen: "fiction_feedback1",
    },
}
*/
